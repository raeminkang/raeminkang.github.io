(function($) {
  $.fn.airklasssearch = function(options) {
      var set = $.extend({
          'contentLocation': 'airklasssearch/airklasssearch_content.json',
          'contextBuffer': 60,
          'contextLength': 60,
          'contextStart': 90,
          'debug': false,
          'descriptiveWords': 25,
          'highlightTerms': true,
          'liveContent': '*',
          'liveDescription': '*',
          'minimumLength': 0,
          'mode': 'static',
          'newWindow': false,
          'show': 5,
          'showContext': true,
          'showRelated': true,
          'showTime': true,
          'showTitleCount': true,
          'showURL': false,
          'wholeWords': true,
          'scoreMode':false,
          'isInputEmpty':false
      }, options);
      return this.each(function() {
          var airklasssearch_in = {
              pages: []
          };
          $.ajaxSetup({
              async: false
          });
          var airklasssearch_t_c = 0;
          $('#search-result-container').hide().html('<div class="airklass_search_spinner"><div class="airklass_search_rect1"></div><div class="airklass_search_rect2"></div><div class="rect3"></div></div>').show();
          if (set.mode == 'live') {
              for (var i = 0; i < airklasssearch_pages.length; i++) {
                  $.get(airklasssearch_pages[i]).done(function(html) {
                      var cont = $(set.liveContent, html).text();
                      cont = cont.replace(/\s+/g, ' ');
                      var desc = $(set.liveDescription, html).text();
                      desc = desc.replace(/\s+/g, ' ');
                      var t_1 = html.toLowerCase().indexOf('<title>');
                      var t_2 = html.toLowerCase().indexOf('</title>', t_1 + 7);
                      if (t_1 != -1 && t_2 != -1) {
                          var tit = html.slice(t_1 + 7, t_2);
                      } else {
                          var tit = airklasssearch_string_1;
                      }
                      airklasssearch_in.pages.push({
                          "title": tit,
                          "text": desc,
                          "tags": cont,
                          "url": airklasssearch_pages[i]
                      });
                  });
              }
          }
          if (set.mode == 'json') {
              $.getJSON(set.contentLocation).done(function(json) {
                  airklasssearch_in = $.extend({}, json);
              });
          }
          if (set.mode == 'static') {
              airklasssearch_in = $.extend({}, airklasssearch);
          }
          var airklass_search_w = '';
          if (set.newWindow) {
              airklass_search_w = ' target="_blank"';
          }

          function getURLP(name) {
              var _locSearch = location.search;
              var _splitted = (new RegExp('[?|&]' + name + '=' + '([^&;]+?)(&|#|;|$)').exec(_locSearch) || [, ""]);
              var searchString = _splitted[1].replace(/\+/g, '%20');
              var a = unescape(_splitted[1].replace(/\+/g, ''));
              try {
                  searchString = decodeURIComponent(searchString);
              } catch (e) {
                  searchString = unescape(searchString);
              }
              if (searchString == "" || unescape(a).length == 0 ) {
                set.isInputEmpty = true;
                searchString = "empty"
              }
              return searchString || null;
          }

          if (getURLP('search')) {
              if (!set.isInputEmpty) {
                $('#header-search-text').val(getURLP('search'));
                getTipueSearch(0, true);
              } else {
                emptySearchResult();
              }
          } 

          $(this).keyup(function(event) {
              if (event.keyCode == '13') {
                if (!set.isInputEmpty) {
                  getTipueSearch(0, true);
                } else {
                  emptySearchResult();
                }
              }
          });

          function emptySearchResult() {
            document.getElementById("user-input-text").textContent = "검색어를 입력 해주세요.";
            document.getElementById("user-input-text-sub").textContent = "";
          }

          function getTipueSearch(start, replace) {
              var out = '';
              var show_replace = false;
              var show_stop = false;
              var standard = true;
              var c = 0;
              found = [];
              var d_o = $('#header-search-text').val();
              var d = d_o.toLowerCase();
              d = $.trim(d);
              if ((d.match("^\"") && d.match("\"$")) || (d.match("^'") && d.match("'$"))) {
                  standard = false;
              }
              var d_w = d.split(' ');
              if (standard) {
                  d = '';
                  for (var i = 0; i < d_w.length; i++) {
                      var a_w = true;
                      for (var f = 0; f < airklasssearch_stop_words.length; f++) {
                          if (d_w[i] == airklasssearch_stop_words[f]) {
                              a_w = false;
                              show_stop = true;
                          }
                      }
                      if (a_w) {
                          d = d + ' ' + d_w[i];
                      }
                  }
                  d = $.trim(d);
                  d_w = d.split(' ');
              } else {
                  d = d.substring(1, d.length - 1);
              }
              if (d.length >= set.minimumLength) {
                  if (standard) {
                      if (replace) {
                          var d_r = d;
                          // javscript -> javascript로 변환하는 검색 ( 오타 검증 검색 )하게 해주는 array 
                          for (var i = 0; i < d_w.length; i++) {
                              for (var f = 0; f < airklasssearch_replace.words.length; f++) {
                                  if (d_w[i] == airklasssearch_replace.words[f].word) {
                                      d = d.replace(d_w[i], airklasssearch_replace.words[f].replace_with);
                                      show_replace = true;
                                  }
                              }
                          }
                          d_w = d.split(' ');
                      }
                      var d_t = d;
                      // airklasssearch_stem : e-mail이 email로, javascript가 js로 적혀있는 array 
                      for (var i = 0; i < d_w.length; i++) {
                          for (var f = 0; f < airklasssearch_stem.words.length; f++) {
                              if (d_w[i] == airklasssearch_stem.words[f].word) {
                                  d_t = d_t + ' ' + airklasssearch_stem.words[f].stem;
                              }
                          }
                      }
                      // airklasssearch_in.pages equal {{ site.posts }} ( have all posts )
                      d_w = d_t.split(' ');
                      for (var i = 0; i < airklasssearch_in.pages.length; i++) {
                          var score = 0;
                          var s_t = airklasssearch_in.pages[i].text;
                          if (set.scoreMode) {
                              for (var f = 0; f < d_w.length; f++) {
                              if (set.wholeWords) {
                                  var pat = new RegExp('\\b' + d_w[f] + '\\b', 'gi');
                              } else {
                                  var pat = new RegExp(d_w[f], 'gi');
                              }
                              if (airklasssearch_in.pages[i].title.search(pat) != -1) {
                                  var m_c = airklasssearch_in.pages[i].title.match(pat).length;
                                  score += (20 * m_c);
                              }
                              if (airklasssearch_in.pages[i].text.search(pat) != -1) {
                                  var m_c = airklasssearch_in.pages[i].text.match(pat).length;
                                  score += (20 * m_c);
                              }
                              if (airklasssearch_in.pages[i].tags.search(pat) != -1) {
                                  var m_c = airklasssearch_in.pages[i].tags.match(pat).length;
                                  score += (10 * m_c);
                              }
                              if (airklasssearch_in.pages[i].url.search(pat) != -1) {
                                  score += 20;
                              }
                              if (score != 0) {
                                  for (var e = 0; e < airklasssearch_weight.weight.length; e++) {
                                      if (airklasssearch_in.pages[i].url == airklasssearch_weight.weight[e].url) {
                                          score += airklasssearch_weight.weight[e].score;
                                      }
                                  }
                              }
                              if (d_w[f].match('^-')) {
                                  pat = new RegExp(d_w[f].substring(1), 'i');
                                  if (airklasssearch_in.pages[i].title.search(pat) != -1 || airklasssearch_in.pages[i].text.search(pat) != -1 || airklasssearch_in.pages[i].tags.search(pat) != -1) {
                                      score = 0;
                                  }
                              }
                            }
                            if (score != 0) {
                              found.push({
                                "score": score,
                                "title": airklasssearch_in.pages[i].title,
                                "desc": s_t,
                                "url": airklasssearch_in.pages[i].url,
                                "article_html": airklasssearch_in.pages[i].article_html
                              });
                              c++;
                            }
                          } else {
                            for (var f = 0; f < d_w.length; f++) {
                              if (set.wholeWords) {
                                  var pat = new RegExp('\\b' + d_w[f] + '\\b', 'gi');
                              } else {
                                  var pat = new RegExp(d_w[f], 'gi');
                              }
                              if (airklasssearch_in.pages[i].title.search(pat) != -1) {
                                  var m_c = airklasssearch_in.pages[i].title.match(pat).length;
                                  score = 1;
                              }
                              if (airklasssearch_in.pages[i].text.search(pat) != -1) {
                                  var m_c = airklasssearch_in.pages[i].text.match(pat).length;
                                  score = 1;
                              }
                              if (airklasssearch_in.pages[i].tags.search(pat) != -1) {
                                  var m_c = airklasssearch_in.pages[i].tags.match(pat).length;
                                  score = 1;
                              }
                              if (airklasssearch_in.pages[i].url.search(pat) != -1) {
                                  score = 1;
                              }
                              if (score != 0) {
                                  for (var e = 0; e < airklasssearch_weight.weight.length; e++) {
                                      if (airklasssearch_in.pages[i].url == airklasssearch_weight.weight[e].url) {
                                          score += airklasssearch_weight.weight[e].score;
                                      }
                                  }
                              }
                              if (d_w[f].match('^-')) {
                                  pat = new RegExp(d_w[f].substring(1), 'i');
                                  if (airklasssearch_in.pages[i].title.search(pat) != -1 || airklasssearch_in.pages[i].text.search(pat) != -1 || airklasssearch_in.pages[i].tags.search(pat) != -1) {
                                      score = 0;
                                  }
                              }
                            }
                            if (score != 0) {
                              found.push({
                                "score": score,
                                "title": airklasssearch_in.pages[i].title,
                                "desc": s_t,
                                "url": airklasssearch_in.pages[i].url,
                                "article_html": airklasssearch_in.pages[i].article_html
                              });
                              c++;
                            }
                          }
                      }
                  } else {
                      for (var i = 0; i < airklasssearch_in.pages.length; i++) {
                          var score = 0;
                          var s_t = airklasssearch_in.pages[i].text;
                          var pat = new RegExp(d, 'gi');
                          if (airklasssearch_in.pages[i].title.search(pat) != -1) {
                              var m_c = airklasssearch_in.pages[i].title.match(pat).length;
                              score += (20 * m_c);
                          }
                          if (airklasssearch_in.pages[i].text.search(pat) != -1) {
                              var m_c = airklasssearch_in.pages[i].text.match(pat).length;
                              score += (20 * m_c);
                          }
                          if (airklasssearch_in.pages[i].tags.search(pat) != -1) {
                              var m_c = airklasssearch_in.pages[i].tags.match(pat).length;
                              score += (10 * m_c);
                          }
                          if (airklasssearch_in.pages[i].url.search(pat) != -1) {
                              score += 20;
                          }
                          if (score != 0) {
                              for (var e = 0; e < airklasssearch_weight.weight.length; e++) {
                                  if (airklasssearch_in.pages[i].url == airklasssearch_weight.weight[e].url) {
                                      score += airklasssearch_weight.weight[e].score;
                                  }
                              }
                          }
                          if (score != 0) {
                              found.push({
                                "score": score,
                                "title": airklasssearch_in.pages[i].title,
                                "desc": s_t,
                                "url": airklasssearch_in.pages[i].url,
                                "article_html": airklasssearch_in.pages[i].article_html
                              });
                              c++;
                          }
                      }
                  }
                  if (c != 0) {
                      if (set.showTitleCount && airklasssearch_t_c == 0) {
                          var title = document.title;
                          document.title = '(' + c + ') ' + title;
                          airklasssearch_t_c++;
                      }
                      if (show_replace) {
                          out += '<div id="airklass_search_warning">' + airklasssearch_string_2 + ' ' + d + '. ' + airklasssearch_string_3 + ' <a id="airklass_search_replaced">' + d_r + '</a></div>';
                      }
                      if (c == 1) {
                          out += '<div style="margin-bottom:20px;"><span class="total_meta_num">' + airklasssearch_string_4 + '</span>';
                      } else {
                          c_c = c.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                          out += '<div style="margin-bottom:20px;"><span class="total_meta_num">' + airklasssearch_string_16 + c_c + '</span>';
                      }
                      if (set.showTime) {
                          var endTimer = new Date().getTime();
                          var time = (endTimer - startTimer) / 1000;
                          out += ' (' + time.toFixed(2) + ' ' + airklasssearch_string_14 + ')';
                          set.showTime = false;
                      }
                      out += '</div>';
                      found.sort(function(a, b) {
                          return b.score - a.score
                      });
                      var l_o = 0;
                      for (var i = 0; i < found.length; i++) {
                          if (l_o >= start && l_o < set.show + start) {
                              // out += '<div class="search-result-container_title"><a href="' + found[i].url + '"' + airklass_search_w + '>' + found[i].title + '</a></div>';
                              // if (set.debug) {
                              //     out += '<div class="search-result-container_debug">Score: ' + found[i].score + '</div>';
                              // }
                              // if (set.showURL) {
                              //     var s_u = found[i].url.toLowerCase();
                              //     if (s_u.indexOf('http://') == 0) {
                              //         s_u = s_u.slice(7);
                              //     }
                              //     out += '<div class="search-result-container_url"><a href="' + found[i].url + '"' + airklass_search_w + '>' + s_u + '</a></div>';
                              // }
                              // if (found[i].desc) {
                              //     var t = found[i].desc;
                              //     if (set.showContext) {
                              //         d_w = d.split(' ');
                              //         var s_1 = found[i].desc.toLowerCase().indexOf(d_w[0]);
                              //         if (s_1 > set.contextStart) {
                              //             var t_1 = t.substr(s_1 - set.contextBuffer);
                              //             var s_2 = t_1.indexOf(' ');
                              //             t_1 = t.substr(s_1 - set.contextBuffer + s_2);
                              //             t_1 = $.trim(t_1);
                              //             if (t_1.length > set.contextLength) {
                              //                 t = '... ' + t_1;
                              //             }
                              //         }
                              //     }
                              //     if (standard) {
                              //         d_w = d.split(' ');
                              //         for (var f = 0; f < d_w.length; f++) {
                              //             if (set.highlightTerms) {
                              //                 var patr = new RegExp('(' + d_w[f] + ')', 'gi');
                              //                 t = t.replace(patr, "<h0011>$1<h0012>");
                              //             }
                              //         }
                              //     } else if (set.highlightTerms) {
                              //         var patr = new RegExp('(' + d + ')', 'gi');
                              //         t = t.replace(patr, "<span class=\"search-result-container_bold\">$1</span>");
                              //     }
                              //     var t_d = '';
                              //     var t_w = t.split(' ');
                              //     if (t_w.length < set.descriptiveWords) {
                              //         t_d = t;
                              //     } else {
                              //         for (var f = 0; f < set.descriptiveWords; f++) {
                              //             t_d += t_w[f] + ' ';
                              //         }
                              //     }
                              //     t_d = $.trim(t_d);
                              //     if (t_d.charAt(t_d.length - 1) != '.') {
                              //         t_d += ' ...';
                              //     }
                              //     t_d = t_d.replace(/h0011/g, 'span class=\"search-result-container_bold\"');
                              //     t_d = t_d.replace(/h0012/g, '/span');
                              //     out += '<div class="search-result-container_text">' + t_d + '</div>';
                              // }
                              out += found[i].article_html
                          }
                          l_o++;
                      }
                      if (set.showRelated && standard) {
                          f = 0;
                          for (var i = 0; i < airklasssearch_related.searches.length; i++) {
                              if (d == airklasssearch_related.searches[i].search) {
                                  if (show_replace) {
                                      d_o = d;
                                  }
                                  if (!f) {
                                      out += '<div class="airklass_search_related_title">' + airklasssearch_string_15 + ' <span class="airklass_search_related_bold">' + d_o + '</span></div><div class="airklass_search_related_cols">';
                                  }
                                  out += '<div class="airklass_search_related_text"><a class="airklass_search_related" id="' + airklasssearch_related.searches[i].related + '">';
                                  if (airklasssearch_related.searches[i].before) {
                                      out += '<span class="airklass_search_related_before">' + airklasssearch_related.searches[i].before + '</span> ';
                                  }
                                  out += airklasssearch_related.searches[i].related;
                                  if (airklasssearch_related.searches[i].after) {
                                      out += ' <span class="airklass_search_related_after">' + airklasssearch_related.searches[i].after + '</span>';
                                  }
                                  out += '</a></div>';
                                  f++;
                              }
                          }
                          if (f) {
                              out += '</div>';
                          }
                      }
                      if (c > set.show) {
                          var pages = Math.ceil(c / set.show);
                          var page = (start / set.show);
                          var page_set =  Math.floor(page / 5);
                          var page_start = page_set * 5 + 1;
                          var page_end = page_start + 4;
                          if (page_end > pages) {
                            page_end = pages;
                          }

                          out += '<nav><div id="pagination"><ul id="airklass_search_foot_boxes" class="pagination-inline-list">';
                          if (start > 0 && page_set != 0) {
                            var previous_post_num = start - set.show * 5;
                            if (previous_post_num < 0) {
                              previous_post_num = 0;
                            }
                              out += '<li role="navigation"><div class="page-outline"><div style="text-align: center;"><a class="search-result-paginator" style="cursor:pointer;" accesskey="b" id="' + previous_post_num + '_' + replace + '">' + airklasssearch_string_6 + '</a></div></div></li>';
                          }
                          if (page <= 4) {
                              var p_b = pages;
                              if (pages > 5) {
                                  p_b = 5;
                              }
                              for (var f = 0; f < p_b; f++) {
                                  if (f == page) {
                                      out += '<li class="current-paginator-page-outline" role="navigation"><div class="page-outline"><div style="text-align: center;"><span>' + (f + 1) + '</span></div></div></li>';
                                  } else {
                                      out += '<li class="paginator-page-outline" role="navigation"><div class="page-outline"><div style="text-align: center;"><a class="search-result-paginator" style="cursor:pointer;" id="' + (f * set.show) + '_' + replace + '">' + (f + 1) + '</a></div></div></li>';
                                  }
                              }
                          } else {
                              var p_b = page + 4;
                              if (p_b > pages) {
                                  p_b = page_end;
                              }
                              for (var f = page_start - 1 ; f < page_end ; f++) {
                                  if (f == page) {
                                      out += '<li class="current-paginator-page-outline" role="navigation"><div class="page-outline"><div style="text-align: center;"><span>' + (f + 1) + '</span></div></div></li>';
                                  } else {
                                      out += '<li class="paginator-page-outline" role="navigation"><div class="page-outline"><div style="text-align: center;"><a class="search-result-paginator" style="cursor:pointer;" id="' + (f * set.show) + '_' + replace + '">' + (f + 1) + '</a></div></div></li>';
                                  }
                              }
                          }
                          if (page + 1 != pages && pages != page_end) {
                            var next_post_num = (page + set.show) * 5;
                            if (next_post_num > c) {
                              next_post_num = (pages - 1) * 5;
                            }
                              out += '<li class="paginator-page-outline" role="navigation"><div class="page-outline"><a class="search-result-paginator" accesskey="m" style="cursor:pointer;" id="' + next_post_num + '_' + replace + '">' + airklasssearch_string_7 + '</a></div></li>';
                          }
                          out += '</ul></div></nav>';
                      }
                      document.getElementById("user-input-text").textContent = getURLP('search');
                  } else {
                      document.getElementById("user-input-text").textContent = getURLP('search');
                      document.getElementById("user-input-text-sub").textContent = "에 대한 결과가 없습니다.";
                  }
              } else {
                  if (show_stop) {
                      out += '<div id="airklass_search_warning">' + airklasssearch_string_8 + '. ' + airklasssearch_string_9 + '</div>';
                  } else {
                      out += '<div id="airklass_search_warning">' + airklasssearch_string_10 + '</div>';
                      if (set.minimumLength == 1) {
                          out += '<div id="airklass_search_warning">' + airklasssearch_string_11 + '</div>';
                      } else {
                          out += '<div id="airklass_search_warning">' + airklasssearch_string_12 + ' ' + set.minimumLength + ' ' + airklasssearch_string_13 + '</div>';
                      }
                  }
              }
              $('#search-result-container').hide().html(out).slideDown(200);
              $('#airklass_search_replaced').click(function() {
                  getTipueSearch(0, false);
              });
              $('.airklass_search_related').click(function() {
                  $('#header-search-text').val($(this).attr('id'));
                  getTipueSearch(0, true);
              });
              $('.search-result-paginator').click(function() {
                  var id_v = $(this).attr('id');
                  var id_a = id_v.split('_');
                  getTipueSearch(parseInt(id_a[0]), id_a[1]);
              });
          }
      });
  };
})(jQuery);